name: Generate Master Indexes for Properties and Requests

on:
  push:
    branches:
      - main
    paths:
      - 'data/properties/**/*.json'
      - 'data/requests/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_indexes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup jq
        run: sudo apt-get install jq -y

      - name: Generate master index for properties
        run: |
          echo "ðŸ” Generating properties index..."
          INDEX_FILE="data/properties_index.json"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© JSON Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… jq
          find data/properties -type f -name '*.json' ! -name 'index.json' -exec \
            jq -n --arg path {} '{
              id: (input_filename | split("/")[-1] | split(".")[0]),
              path: ("/" + $path)
            }' {} + | jq -s '.' > $INDEX_FILE
          
          echo "âœ… Master properties index generated at $INDEX_FILE"
          cat $INDEX_FILE

      - name: Generate master index for requests
        run: |
          echo "ðŸ” Generating requests index..."
          INDEX_FILE="data/requests_index.json"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© JSON Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… jq
          find data/requests -type f -name '*.json' ! -name 'index.json' -exec \
            jq -n --arg path {} '{
              id: (input_filename | split("/")[-1] | split(".")[0]),
              path: ("/" + $path)
            }' {} + | jq -s '.' > $INDEX_FILE
          
          echo "âœ… Master requests index generated at $INDEX_FILE"
          cat $INDEX_FILE

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-update properties and requests indexes"
          file_pattern: "data/properties_index.json data/requests_index.json"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
