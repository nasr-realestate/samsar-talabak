name: Generate Master Indexes for Properties and Requests

on:
  push:
    branches:
      - main
    paths:
      - 'data/properties/**/*.json'
      - 'data/requests/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_indexes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate master index for properties
        id: generate_properties_index
        run: |
          echo "ğŸ” Finding all property JSON files..."
          INDEX_FILE="data/properties_index.json"
          echo "[" > $INDEX_FILE
          
          # Find all json files, extract id and generate the path
          find data/properties -type f -name '*.json' ! -name 'index.json' | while read file; do
            # Extract the id, skip if not found
            id=$(grep -o '"id": *[0-9]*' "$file" | sed 's/"id": *//' | tr -d ',')
            if [ -n "$id" ]; then
              path="/$file"
              echo "  {" >> $INDEX_FILE
              echo "    \"id\": $id," >> $INDEX_FILE
              echo "    \"path\": \"$path\"" >> $INDEX_FILE
              echo "  }," >> $INDEX_FILE
            else
              echo "âš ï¸ Warning: No 'id' field found in $file. Skipping."
            fi
          done

          # Remove trailing comma from the last entry
          sed -i '$ s/},/}/' $INDEX_FILE
          echo "]" >> $INDEX_FILE
          echo "âœ… Master properties index generated at $INDEX_FILE"

      - name: Generate master index for requests
        id: generate_requests_index
        run: |
          echo "ğŸ” Finding all request JSON files..."
          INDEX_FILE="data/requests_index.json"
          echo "[" > $INDEX_FILE
          
          find data/requests -type f -name '*.json' ! -name 'index.json' | while read file; do
            id=$(grep -o '"id": *[0-9]*' "$file" | sed 's/"id": *//' | tr -d ',')
            if [ -n "$id" ]; then
              path="/$file"
              echo "  {" >> $INDEX_FILE
              echo "    \"id\": $id," >> $INDEX_FILE
              echo "    \"path\": \"$path\"" >> $INDEX_FILE
              echo "  }," >> $INDEX_FILE
            else
              echo "âš ï¸ Warning: No 'id' field found in $file. Skipping."
            fi
          done

          sed -i '$ s/},/}/' $INDEX_FILE
          echo "]" >> $INDEX_FILE
          echo "âœ… Master requests index generated at $INDEX_FILE"

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
          file_pattern: "data/properties_index.json data/requests_index.json"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
