name: Generate Master Indexes for Properties and Requests

on:
  push:
    branches:
      - main
    paths:
      - 'data/properties/**/*.json'
      - 'data/requests/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_indexes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate master index for properties
        run: |
          echo "ðŸ” Generating properties index..."
          INDEX_FILE="data/properties_index.json"
          echo "[" > $INDEX_FILE
          
          find data/properties -type f -name '*.json' ! -name 'index.json' | while read file; do
            id=$(grep -o '"id": *"[^"]*"' "$file" | sed 's/"id": *"\([^"]*\)"/\1/')
            if [ -n "$id" ]; then
              path="${file}"
              echo "  {" >> $INDEX_FILE
              echo "    \"id\": \"$id\"," >> $INDEX_FILE
              echo "    \"path\": \"$path\"" >> $INDEX_FILE
              echo "  }," >> $INDEX_FILE
            else
              echo "âš ï¸ Warning: No 'id' field found in $file. Skipping."
            fi
          done

          sed -i '$ s/},/}/' $INDEX_FILE
          echo "]" >> $INDEX_FILE
          echo "âœ… Master properties index generated at $INDEX_FILE"

      - name: Generate master index for requests
        run: |
          echo "ðŸ” Generating requests index..."
          INDEX_FILE="data/requests_index.json"
          echo "[" > $INDEX_FILE
          
          find data/requests -type f -name '*.json' ! -name 'index.json' | while read file; do
            id=$(grep -o '"id": *"[^"]*"' "$file" | sed 's/"id": *"\([^"]*\)"/\1/')
            if [ -n "$id" ]; then
              path="${file}"
              echo "  {" >> $INDEX_FILE
              echo "    \"id\": \"$id\"," >> $INDEX_FILE
              echo "    \"path\": \"$path\"" >> $INDEX_FILE
              echo "  }," >> $INDEX_FILE
            else
              echo "âš ï¸ Warning: No 'id' field found in $file. Skipping."
            fi
          done

          sed -i '$ s/},/}/' $INDEX_FILE
          echo "]" >> $INDEX_FILE
          echo "âœ… Master requests index generated at $INDEX_FILE"

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-update properties and requests indexes"
          file_pattern: "data/properties_index.json data/requests_index.json"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
