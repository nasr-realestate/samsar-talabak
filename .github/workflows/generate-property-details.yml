name: Generate HTML from JSON

on:
  push:
    paths:
      - 'data/properties/**/*.json'
  workflow_dispatch:

jobs:
  generate-html:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Generate HTML files
      run: |
        for json_file in data/properties/*/*.json; do
          if [[ "$(basename "$json_file")" == "index.json" ]]; then
            continue
          fi

          filename=$(basename "$json_file" .json)
          folder=$(dirname "$json_file")

          title=$(jq -r '.title' "$json_file")
          price=$(jq -r '.price' "$json_file")
          area=$(jq -r '.area' "$json_file")
          description=$(jq -r '.description' "$json_file")

          html_file="${folder}/${filename}.html"
          echo "---" > "$html_file"
          echo "layout: default" >> "$html_file"
          echo "title: $title" >> "$html_file"
          echo "description: $description" >> "$html_file"
          echo "---" >> "$html_file"

          cat <<EOF >> "$html_file"
<main class="property-details">
  <div class="detail-section">
    <h1 class="section-title">$title</h1>
    <div class="price-tag">$price</div>
    <p><strong>المساحة:</strong> $area</p>
    <p><strong>الوصف:</strong> $description</p>

    <div style="margin-top: 2rem;">
      <a href="https://wa.me/201147758857?text=أريد الاستفسار عن $title" 
         class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i> استفسر عبر واتساب
      </a>
    </div>

    <div style="margin-top: 2rem;">
      <a href="/samsar-talabak/properties-filtered.html" class="back-btn">
        ← العودة للعقارات
      </a>
    </div>
  </div>
</main>
EOF
        done

    - name: Commit and push changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add data/properties/**/*.html
        git commit -m "Generated HTML files from JSON"
        git push
