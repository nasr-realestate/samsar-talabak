name: Generate Property Details Pages

on:
  push:
    paths:
      - 'data/properties/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-html:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate HTML Pages
        run: |
          for file in data/properties/*/*.json; do
            title=$(jq -r '.title' "$file")
            price=$(jq -r '.price' "$file")
            area=$(jq -r '.area' "$file")
            description=$(jq -r '.description' "$file")
            filename=$(basename "$file" .json)
            category=$(basename $(dirname "$file"))

            output_path="data/properties/$category/$filename.html"

            echo "---" > "$output_path"
            echo "layout: default" >> "$output_path"
            echo "title: \"$title\"" >> "$output_path"
            echo "description: \"$description\"" >> "$output_path"
            echo "---" >> "$output_path"
            echo "" >> "$output_path"
            echo "<main class=\"property-details\">" >> "$output_path"
            echo "  <div class=\"detail-section\">" >> "$output_path"
            echo "    <h1 class=\"section-title\">$title</h1>" >> "$output_path"
            echo "    <div class=\"price-tag\">$price</div>" >> "$output_path"
            echo "    <p><strong>المساحة:</strong> $area</p>" >> "$output_path"
            echo "    <p><strong>الوصف:</strong> $description</p>" >> "$output_path"
            echo "    <div style=\"margin-top: 2rem;\">" >> "$output_path"
            echo "      <a href=\"https://wa.me/201147758857?text=أريد الاستفسار عن $title\"" >> "$output_path"
            echo "         class=\"whatsapp-btn\" target=\"_blank\">" >> "$output_path"
            echo "        <i class=\"fab fa-whatsapp\"></i> استفسر عبر واتساب" >> "$output_path"
            echo "      </a>" >> "$output_path"
            echo "    </div>" >> "$output_path"
            echo "    <div style=\"margin-top: 2rem;\">" >> "$output_path"
            echo "      <a href=\"/samsar-talabak/properties-filtered.html\" class=\"back-btn\">" >> "$output_path"
            echo "        ← العودة للعقارات" >> "$output_path"
            echo "      </a>" >> "$output_path"
            echo "    </div>" >> "$output_path"
            echo "  </div>" >> "$output_path"
            echo "</main>" >> "$output_path"
          done

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/properties/**/*.html
          git commit -m "✅ Generated HTML detail pages"
          git push
