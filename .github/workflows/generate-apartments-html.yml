name: Build and Deploy Property Data and Pages

on:
  push:
    paths:
      - '_data/apartments-source/**'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate master data file (_data/apartments.json)
        run: |
          echo "📦 Aggregating all source JSON files into one master file..."
          mkdir -p _data
          jq -s '.' _data/apartments-source/*.json > _data/apartments.json
          echo "✅ Master data file _data/apartments.json created successfully."

      - name: Generate individual HTML detail pages
        run: |
          echo "🏠 Generating individual HTML pages for each property..."
          mkdir -p properties 
          
          for source_file in _data/apartments-source/*.json; do
            filename=$(basename "$source_file" .json)
            title=$(jq -r '.location_ar // "عقار غير محدد"' "$source_file")
            price=$(jq -r '.السعر // "عند الطلب"' "$source_file")
            area=$(jq -r '.المساحة // "-"' "$source_file")
            description=$(jq -r '.تفاصيل // "لا توجد تفاصيل إضافية."' "$source_file")
            html_file="properties/${filename}.html"

            echo "  - Creating page: ${html_file}"

            cat <<'EOF' > "$html_file"
---
layout: default
title: "'$title'"
description: "تفاصيل العقار: $title بسعر $price"
---

<style>
  .property-details { max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; }
  .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
  .back-btn { display: inline-block; margin-top: 20px; color: var(--primary); }
</style>

<main class="property-details">
  <h1>$title</h1>
  <p style="font-size: 1.5rem; color: var(--secondary); font-weight: bold;">$price</p>
  <hr style="margin: 20px 0;">
  <p><strong>المساحة:</strong> $area</p>
  <p><strong>الوصف:</strong> $description</p>
  <div style="margin-top: 2rem;">
    <a href="https://wa.me/201147758857?text=أريد الاستفسار عن $title" class="whatsapp-btn" target="_blank">
      استفسر عبر واتساب
    </a>
  </div>
  <div style="margin-top: 1rem;">
    <a href="/samsar-talabak/properties-filtered.html" class="back-btn">
      ← العودة للعقارات
    </a>
  </div>
</main>
EOF

          done
          echo "✅ All detail pages generated."

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 تحديث تلقائي لبيانات وصفحات العقارات"
          file_pattern: "_data/apartments.json properties/*.html"
