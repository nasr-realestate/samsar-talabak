name: Build and Deploy Property Data and Pages

on:
  push:
    paths:
      - '_data/apartments-source/**'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate master data file (_data/apartments.json)
        run: |
          echo "ğŸ“¦ Aggregating all source JSON files into one master file..."
          mkdir -p _data
          jq -s '.' _data/apartments-source/*.json > _data/apartments.json
          echo "âœ… Master data file _data/apartments.json created successfully."

      - name: Generate individual HTML detail pages
        run: |
          echo "ğŸ  Generating individual HTML pages for each property..."
          mkdir -p properties 
          
          for source_file in _data/apartments-source/*.json; do
            filename=$(basename "$source_file" .json)
            title=$(jq -r '.location_ar // "Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…Ø­Ø¯Ø¯"' "$source_file")
            price=$(jq -r '.Ø§Ù„Ø³Ø¹Ø± // "Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨"' "$source_file")
            area=$(jq -r '.Ø§Ù„Ù…Ø³Ø§Ø­Ø© // "-"' "$source_file")
            description=$(jq -r '.ØªÙØ§ØµÙŠÙ„ // "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©."' "$source_file")
            html_file="properties/${filename}.html"

            echo "  - Creating page: ${html_file}"

            cat <<'EOF' > "$html_file"
---
layout: default
title: "'$title'"
description: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±: $title Ø¨Ø³Ø¹Ø± $price"
---

<style>
  .property-details { max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; }
  .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
  .back-btn { display: inline-block; margin-top: 20px; color: var(--primary); }
</style>

<main class="property-details">
  <h1>$title</h1>
  <p style="font-size: 1.5rem; color: var(--secondary); font-weight: bold;">$price</p>
  <hr style="margin: 20px 0;">
  <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> $area</p>
  <p><strong>Ø§Ù„ÙˆØµÙ:</strong> $description</p>
  <div style="margin-top: 2rem;">
    <a href="https://wa.me/201147758857?text=Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† $title" class="whatsapp-btn" target="_blank">
      Ø§Ø³ØªÙØ³Ø± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
    </a>
  </div>
  <div style="margin-top: 1rem;">
    <a href="/samsar-talabak/properties-filtered.html" class="back-btn">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
    </a>
  </div>
</main>
EOF

          done
          echo "âœ… All detail pages generated."

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØµÙØ­Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª"
          file_pattern: "_data/apartments.json properties/*.html"
