name: Generate index.json and HTML pages

on:
  push:
    paths:
      - 'data/properties/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq

      - name: Generate index.json and HTML pages
        run: |
          for dir in data/properties/*/; do
            if [ -d "$dir" ]; then
              echo "â³ Generating index.json in $dir"
              echo "[" > "$dir/index.json"
              find "$dir" -maxdepth 1 -type f -name '*.json' ! -name 'index.json' | sed "s|$dir||" | awk '{ print "  \"" $0 "\"," }' >> "$dir/index.json"
              sed -i '$ s/,$//' "$dir/index.json"
              echo "]" >> "$dir/index.json"

              echo "âœ… Done: $dir/index.json"
            fi

            for json_file in "$dir"*.json; do
              [ -f "$json_file" ] || continue
              filename=$(basename "$json_file" .json)

              title=$(jq -r '.title' "$json_file")
              price=$(jq -r '.price' "$json_file")
              area=$(jq -r '.area' "$json_file")
              description=$(jq -r '.description' "$json_file")

              html_path="$dir/${filename}.html"

cat <<EOF > "$html_path"
---
layout: default
title: "$title"
description: "$description"
---

<main class="property-details">
  <div class="detail-section">
    <h1 class="section-title">$title</h1>
    <div class="price-tag">$price</div>
    <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> $area</p>
    <p><strong>Ø§Ù„ÙˆØµÙ:</strong> $description</p>

    <div style="margin-top: 2rem;">
      <a href="https://wa.me/201147758857?text=Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† $title" 
         class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i> Ø§Ø³ØªÙØ³Ø± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
      </a>
    </div>

    <div style="margin-top: 2rem;">
      <a href="/samsar-talabak/properties-filtered.html" class="back-btn">
        â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
      </a>
    </div>
  </div>
</main>
EOF

            done
          done

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆÙ…Ù„ÙØ§Øª index.json ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
