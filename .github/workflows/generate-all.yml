# Ø§Ø³Ù… ÙˆØ§Ø¶Ø­ Ù„Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„
name: Build and Deploy Property Data and Pages

on:
  # ÙŠØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±
  push:
    paths:
      - '_data/apartments-source/**'
    branches:
      - main
  # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Actions
  workflow_dispatch:

# ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
permissions:
  contents: write

jobs:
  # Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Ø¬Ù„Ø¨ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ØªØ«Ø¨ÙŠØª Ø£Ø¯Ø§Ø© jq Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© JSON
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3. ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø­Ø¯ Ø±Ø¦ÙŠØ³ÙŠ (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§)
      - name: Generate master data file (_data/apartments.json)
        run: |
          echo "ğŸ“¦ Aggregating all source JSON files into one master file..."
          # *** Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ***
          mkdir -p _data
          # Ø§Ù„Ø£Ù…Ø± jq -s ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ JSON ÙÙŠ Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø©
          jq -s '.' _data/apartments-source/*.json > _data/apartments.json
          echo "âœ… Master data file _data/apartments.json created successfully."

      # 4. Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© HTML Ù„ÙƒÙ„ Ø¹Ù‚Ø§Ø± Ø¹Ù„Ù‰ Ø­Ø¯Ø©
      - name: Generate individual HTML detail pages
        run: |
          echo "ğŸ  Generating individual HTML pages for each property..."
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„ØµÙØ­Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
          mkdir -p properties 
          
          # Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ù„Ù Ù…ØµØ¯Ø±
          for source_file in _data/apartments-source/*.json; do
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
            filename=$(basename "$source_file" .json)
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… jq
            title=$(jq -r '.location_ar // "Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…Ø­Ø¯Ø¯"' "$source_file")
            price=$(jq -r '.Ø§Ù„Ø³Ø¹Ø± // "Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨"' "$source_file")
            area=$(jq -r '.Ø§Ù„Ù…Ø³Ø§Ø­Ø© // "-"' "$source_file")
            description=$(jq -r '.ØªÙØ§ØµÙŠÙ„ // "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©."' "$source_file")
            
            # ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù€ HTML Ø§Ù„Ø¬Ø¯ÙŠØ¯
            html_file="properties/${filename}.html"
            
            echo "  - Creating page: ${html_file}"
            
            # ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ HTML Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… here-document
            cat << EOF > "$html_file"
---
layout: default
title: "$title"
description: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±: $title Ø¨Ø³Ø¹Ø± $price"
---

<style>
  .property-details { max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; }
  .whatsapp-btn { display: inline-block; background: #25D366; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
  .back-btn { display: inline-block; margin-top: 20px; color: var(--primary); }
</style>

<main class="property-details">
  <h1>$title</h1>
  <p style="font-size: 1.5rem; color: var(--secondary); font-weight: bold;">$price</p>
  <hr style="margin: 20px 0;">
  <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> $area</p>
  <p><strong>Ø§Ù„ÙˆØµÙ:</strong> $description</p>
  <div style="margin-top: 2rem;">
    <a href="https://wa.me/201147758857?text=Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† $title" class="whatsapp-btn" target="_blank">
      Ø§Ø³ØªÙØ³Ø± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
    </a>
  </div>
  <div style="margin-top: 1rem;">
    <a href="{{ '/apartments.html' | relative_url }}" class="back-btn">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙƒÙ„ Ø§Ù„Ø´Ù‚Ù‚
    </a>
  </div>
</main>
EOF
          done
          echo "âœ… All detail pages generated."

      # 5. Ø¹Ù…Ù„ Commit Ùˆ Push Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØµÙØ­Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª"
          # Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
          file_pattern: "_data/apartments.json properties/*.html"
