import os
import glob

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
BASE_URL = "https://aqarnasr.netlify.app"
# âœ¨ Ø³Ù†Ù‚Ø±Ø£ Ù…Ù† Ù…Ø¬Ù„Ø¯ _site ÙˆÙ†ÙƒØªØ¨ ÙÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
SITE_DIR = "_site"
SITEMAP_FILE = os.path.join(SITE_DIR, "sitemap.xml")

def generate_xml():
    print("ğŸš€ Starting Final Sitemap Generation (from _site)...")

    if not os.path.isdir(SITE_DIR):
        print(f"âŒ Error: Build directory '{SITE_DIR}' not found. Run Jekyll build first.")
        return

    xml_content = '<?xml version="1.0" encoding="UTF-8"?>\n'
    xml_content += '<!-- GENERATED BY FINAL PYTHON SCRIPT -->\n'
    xml_content += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'

    # 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ ØµÙØ­Ø§Øª HTML ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ù†ÙŠ
    # Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Jekyll
    search_path_html = os.path.join(SITE_DIR, '**', '*.html')
    static_pages_found = 0
    for filepath in glob.glob(search_path_html, recursive=True):
        # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ Ù†Ø±ÙŠØ¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        if "404.html" in filepath:
            continue

        # ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· URL
        relative_path = os.path.relpath(filepath, SITE_DIR)
        # Ø¥Ø²Ø§Ù„Ø© 'index.html' Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù†Ø¸ÙŠÙÙ‹Ø§
        if os.path.basename(relative_path) == 'index.html':
            relative_path = os.path.dirname(relative_path)
        
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù…ØªØ¯Ø§Ø¯ .html
        url_part = relative_path.replace('\\', '/').replace('.html', '')
        
        # ØªØ¬Ù†Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        if url_part == ".":
            url_part = ""
            
        full_url = f"{BASE_URL}/{url_part}"
        
        # ØªØ¬Ø§Ù‡Ù„ Ø±ÙˆØ§Ø¨Ø· ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø£Ù†Ù†Ø§ Ø³Ù†Ø¶ÙŠÙÙ‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
        if 'details.html' in full_url or 'request-details.html' in full_url:
            continue

        xml_content += f'  <url><loc>{full_url}</loc><priority>0.9</priority></url>\n'
        static_pages_found += 1

    # 2. Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Properties) - Ù…Ù† Ù…Ù„ÙØ§Øª JSON ÙÙŠ _site
    search_path_props = os.path.join(SITE_DIR, 'data', 'properties', '**', '*.json')
    properties_found = 0
    for filepath in glob.glob(search_path_props, recursive=True):
        if "index.json" in os.path.basename(filepath): continue
        
        clean_id = os.path.basename(filepath).replace('.json', '')
        category = os.path.basename(os.path.dirname(filepath))
        
        full_url = f"{BASE_URL}/details.html?id={clean_id}&amp;category={category}"
        xml_content += f'  <url><loc>{full_url}</loc><priority>0.8</priority></url>\n'
        properties_found += 1

    # 3. Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Requests) - Ù…Ù† Ù…Ù„ÙØ§Øª JSON ÙÙŠ _site
    search_path_reqs = os.path.join(SITE_DIR, 'data', 'requests', '**', '*.json')
    requests_found = 0
    for filepath in glob.glob(search_path_reqs, recursive=True):
        if "index.json" in os.path.basename(filepath): continue

        clean_id = os.path.basename(filepath).replace('.json', '')
        category = os.path.basename(os.path.dirname(filepath))

        full_url = f"{BASE_URL}/request-details.html?id={clean_id}&amp;category={category}"
        xml_content += f'  <url><loc>{full_url}</loc><priority>0.6</priority></url>\n'
        requests_found += 1

    xml_content += '</urlset>'
    
    with open(SITEMAP_FILE, "w", encoding="utf-8") as f:
        f.write(xml_content)
    
    print(f"\n--- Sitemap Summary ---")
    print(f"HTML Pages Found: {static_pages_found}")
    print(f"Properties Found: {properties_found}")
    print(f"Requests Found: {requests_found}")
    print(f"Total URLs Generated: {static_pages_found + properties_found + requests_found}")
    print(f"âœ… Sitemap successfully written to: {SITEMAP_FILE}")

if __name__ == "__main__":
    generate_xml()
