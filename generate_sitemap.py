import os
import glob

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
BASE_URL = "https://aqarnasr.netlify.app"
OUTPUT_DIR = "_site"  # Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠÙ†Ø´Ø¦Ù‡ Jekyll Ù„Ù„Ù†Ø´Ø±
SITEMAP_FILE = os.path.join(OUTPUT_DIR, "sitemap.xml")

def generate_xml():
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø´Ø± Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ø£Ù†Ù†Ø§ Ø³Ù†Ø¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø¬ÙŠÙƒÙ„)
    if not os.path.exists(OUTPUT_DIR):
        print(f"âš ï¸ Warning: {OUTPUT_DIR} not found. Creating it...")
        os.makedirs(OUTPUT_DIR)

    print("ğŸš€ Starting Custom Sitemap Generation...")

    xml_content = '<?xml version="1.0" encoding="UTF-8"?>\n'
    # Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø³ÙŠØ¤ÙƒØ¯ Ù„Ùƒ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ Ù…Ù„ÙÙ†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    xml_content += '<!-- GENERATED BY AQAR NASR PYTHON SCRIPT -->\n'
    xml_content += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'

    # 1. Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©
    # Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙ…Ù„ÙØ§Øª HTML
    static_pages = [
        "",
        "properties-filtered.html",
        "requests-filtered.html",
        "add-your-property.html",
        "contact-us.html",
        "about-us.html",
        "privacy-policy.html"
    ]
    
    for page in static_pages:
        # Ø¥Ø²Ø§Ù„Ø© .html Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠÙƒÙˆÙ† Ø´ÙƒÙ„Ù‡ Ø£Ø¬Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ ÙˆØ¶Ø¹Ù†Ø§Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ù…Ù„ÙØ§Øª)
        clean_page = page.replace('index.html', '')
        url = f"{BASE_URL}/{clean_page}"
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø§Ø´ Ø§Ù„Ø²Ø§Ø¦Ø¯ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if clean_page == "": url = BASE_URL
        
        xml_content += '  <url>\n'
        xml_content += f'    <loc>{url}</loc>\n'
        xml_content += '    <priority>1.0</priority>\n'
        xml_content += '  </url>\n'

    # 2. Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Ø§Ù„Ø¹Ø±ÙˆØ¶) - Properties
    # Ù†Ø¨Ø­Ø« ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠ: data/properties/category/file.json
    print("--> Scanning Properties...")
    count_props = 0
    # glob pattern to find json files inside subfolders
    for filepath in glob.glob("data/properties/*/*.json"):
        if "index.json" in filepath: continue
        
        filename = os.path.basename(filepath)
        clean_id = filename.replace('.json', '')
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ (apartments, shops...)
        category = os.path.basename(os.path.dirname(filepath))
        
        # Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        # Ù†Ø³ØªØ®Ø¯Ù… &amp; Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† & Ù„Ø£Ù† XML ÙŠØªØ·Ù„Ø¨ Ø°Ù„Ùƒ
        full_url = f"{BASE_URL}/details.html?id={clean_id}&amp;category={category}"
        
        xml_content += '  <url>\n'
        xml_content += f'    <loc>{full_url}</loc>\n'
        xml_content += '    <priority>0.8</priority>\n'
        xml_content += '  </url>\n'
        count_props += 1

    # 3. Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Requests)
    print("--> Scanning Requests...")
    count_reqs = 0
    for filepath in glob.glob("data/requests/*/*.json"):
        if "index.json" in filepath: continue
        
        filename = os.path.basename(filepath)
        clean_id = filename.replace('.json', '')
        category = os.path.basename(os.path.dirname(filepath))
        
        full_url = f"{BASE_URL}/request-details.html?id={clean_id}&amp;category={category}"
        
        xml_content += '  <url>\n'
        xml_content += f'    <loc>{full_url}</loc>\n'
        xml_content += '    <priority>0.6</priority>\n'
        xml_content += '  </url>\n'
        count_reqs += 1

    xml_content += '</urlset>'
    
    # Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø³ÙŠÙƒØªØ¨ ÙÙˆÙ‚ Ø£ÙŠ Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ _site)
    with open(SITEMAP_FILE, "w", encoding="utf-8") as f:
        f.write(xml_content)
    
    print(f"âœ… FINAL SITEMAP GENERATED: {count_props + count_reqs} dynamic links added.")
    print(f"âœ… Saved to: {SITEMAP_FILE}")

if __name__ == "__main__":
    generate_xml()
